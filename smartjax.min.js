var Smartjax=function(){var a={registerGroup:function(a,c){var d=a.group;if(!d)return null;c||(c=b.buildRequestStoreId(a));var e=g.getFullStore(a.store);e||(e={}),e.groups&&e.groups.length||(e.groups=[]);var f=e.groups&&b.findBy(e.groups,"group",a.group);return f||(f={group:a.group,storeIds:[]},e.groups.push(f)),-1==f.storeIds.indexOf(c)&&f.storeIds.push(c),g.setFullStore(e,a.store),!0},clearGroupData:function(a,c){var d=g.getFullStore(c),e=d&&d.groups&&d.groups.length&&b.findBy(d.groups,"group",a),f=d.storeIds;if(!e)return!1;var h=e.storeIds;h&&h.forEach(function(a){f.splice(f.indexOf(a),1),g.clearStoreId(a,c)}),delete e,g.setFullStore(d,c),console.log("group "+a+" cleared from Smartjax store")},clearGroups:function(a,b){a&&a.length&&a.forEach($.proxy(function(a,c){this.clearGroupData(a,b)},this))}},b={buildRequestStoreId:function(a){if(a.id)return a.id;var b="",c=a.url;return c&&("/"!==c[0]&&(b+=c[0]),b+=c.substr(1,c.length-2),"/"!==c[c.length-1]&&(b+=c[c.length-1])),a.data&&(b+=JSON.stringify(a.data)),b},isForce:function(a){return"boolean"==typeof a.force?a.force:f.defaults.alwaysForce},shouldStore:function(a){return"boolean"==typeof a.store?a.store:f.defaults.alwaysStore},getStorageObj:function(a){var b=f.defaults.store,c=null;if("string"==typeof a?b=a:a&&a.store===!1&&(b=null),!Storage)return d;if(b)switch(b.toLowerCase()){case"tab":c=sessionStorage;break;case"page":c=d;break;case"forever":c=localStorage}return c},returnWithAddedStore:function(b){var c=new $.Deferred,d=this.getOriginalRequestObject(b.requestObj),f=b.storeId,h=e.getPromiseFor(f);if(!h){var i=$.ajax(d);i.done(function(d){g.save({key:f,value:d,storeName:b.requestObj.store}),a.registerGroup(b.requestObj,f),c.resolve(d)}),i.fail(function(a){c.reject(a)}),h=e.setAndRefinePromise(f,c.promise())}return h},getOriginalRequestObject:function(a){var b=$.extend({},a);return delete b.store,delete b.force,b},returnFromStore:function(a,b,c){var d=new $.Deferred,e=g.fetch({key:a,storeName:b});return c&&"function"==typeof c&&c(),d.resolve(e),d.promise()},findBy:function(a,b,c){if(!(a&&a.length&&b&&c))return null;var d=$.grep(a,function(a){return a[b]==c});return d&&d.length&&d[0]?d[0]:null},clearAll:function(a){var b=g.getFullStore(a),c=b&&b.storeIds;c&&c.length&&c.forEach(function(b){g.clearStoreId(b,a)}),g.setFullStore({},a),console.log("All Smartjax store data cleared")}},c={replaceURL:function(a){if(window.history&&window.history.pushState){var b={title:"Smartjax Url"};history.pushState(b,"Smartjax Url",a)}},addQueryString:function(a,b){var d=a||" ",e=d.split("#"),f={url:e[0]},g={url:e[1]},h=g.url&&-1!=g.url.indexOf("?")?g:f;"/"===h.url[h.url.length-1]&&(h.url=h.url.slice(h.url.length-1,h.url.length)),b=$.extend({},c.existingQueryParams(h.url),b),h.url=h.url.split("?")[0];for(var i in b)if(b.hasOwnProperty(i)){var j=b[i];h.url+=-1===h.url.indexOf("?")?"?":"&",h.url+=i+"="+j}var k=f.url;return g.url&&(k+="#"+g.url),k},existingQueryParams:function(a){var b={},c=a.split("?")[1];if(c){var d=c.split("&");d.forEach(function(a){a=a.split("=");var c=a[0],d=a[1];b[c]=d})}return b}},d={SmartjaxStore:{},getItem:function(a){return this[a]},setItem:function(a,b){this[a]=b},removeItem:function(a){this.setItem(a,null)}},e={promiseStore:{},getPromiseFor:function(a){return this.promiseStore[a]&&this.promiseStore[a].promise},setAndRefinePromise:function(a,b){this.promiseStore[a]={promise:b};var c=new $.Deferred;return b.then(function(){delete e.promiseStore[a],c.resolve.apply(this,arguments)},function(){delete e.promiseStore[a],c.reject.apply(this,arguments)}),c.promise()}},f={defaults:{defaultMethod:"get",alwaysForce:!1,alwaysStore:!0,defaultStorageName:"SmartjaxStore",store:"tab"},setDefaults:function(a){$.extend(this.defaults,a)},ajax:function(a){var c=b.buildRequestStoreId(a);return!b.isForce(a)&&g.isInStore(c,a.store)?b.returnFromStore(c,a.store,a.success):b.shouldStore(a)?b.returnWithAddedStore({storeId:c,requestObj:a}):$.ajax(b.getOriginalRequestObject(a))},cleanAll:function(a){this.cleanStore({clearAll:!0},a)},cleanStore:function(c,d){var e=c.clearAll;if(e===!0){if(!d)return b.clearAll("page"),b.clearAll("tab"),b.clearAll("forever"),!0;b.clearAll(d)}var f=c.ids;f&&(d?g.remove(f,d):(g.remove(f,"page"),g.remove(f,"tab"),g.remove(f,"forever")));var h=c.groups;h&&(d?a.clearGroups(h,d):(a.clearGroups(h,"page"),a.clearGroups(h,"tab"),a.clearGroups(h,"forever")))},changeUrl:function(a){var b=a.url||window.location.href,d=a.params;d&&(b=c.addQueryString(b,d)),c.replaceURL(b)}},g={getFullStore:function(a){a=a||f.defaults.store;var c=b.getStorageObj(a).getItem("SmartjaxStore");return a&&"page"!=a.toLowerCase()&&(c=JSON.parse(c)),c},setFullStore:function(a,c){c=c||f.defaults.store;var d=b.getStorageObj(c);c&&"page"==c.toLowerCase()?d.setItem("SmartjaxStore",a):d.setItem("SmartjaxStore",JSON.stringify(a))},save:function(a){var c=a.storeName||f.defaults.store,d=b.getStorageObj(c);this.isInStore(a.key,a.storeName)||this.registerNewKey(a.key,a.storeName,{status:"success"});var e=a.value;"page"!=c&&(e=JSON.stringify(e)),d.setItem(a.key,e)},fetch:function(a){var c=b.getStorageObj(a.storeName),d=c.getItem(a.key);return a.storeName&&"page"==a.storeName.toLowerCase()?d:JSON.parse(d)},isInStore:function(a,b){b=b||f.defaults.store;var c=this.getFullStore(b)&&this.getFullStore(b).storeIds;return c&&c.length&&-1!=c.indexOf(a)?!0:!1},registerNewKey:function(a,b,c){b=b||f.defaults.store;var d=this.getFullStore(b);d||(d={}),d.storeIds&&d.storeIds.length||(d.storeIds=[]),d.storeIds.push(a),this.setFullStore(d,b)},clearStoreId:function(a,c){c=c||f.defaults.store;var d=b.getStorageObj(c);d.removeItem(a)},remove:function(a,b){"string"==typeof a&&(a=[a]);var c=g.getFullStore(b);c&&c.storeIds&&(a.forEach(function(a){var d=c.storeIds.indexOf(a);-1!=d&&(c.storeIds.splice(d,1),this.clearStoreId(a,b))}.bind(this)),g.setFullStore(c,b))}};return f}();